// src/hooks/useFirebaseAuth.js
import { useState, useEffect } from 'react';
import FirebaseGoogleAuth from '../services/firebaseGoogleAuth';
import AsyncStorage from '@react-native-async-storage/async-storage';

export const useFirebaseAuth = () => {
    const [user, setUser] = useState(null);
    const [isLoading, setIsLoading] = useState(true); // true au dÃ©but
    const [isSignedIn, setIsSignedIn] = useState(false);
    const [error, setError] = useState(null);

    // ğŸ”„ Ã‰COUTER CHANGEMENTS AUTH AU DÃ‰MARRAGE
    useEffect(() => {
        console.log('ğŸ”„ DÃ©marrage listener Firebase Auth...');

        const unsubscribe = FirebaseGoogleAuth.onAuthStateChanged((authResult) => {
            console.log('ğŸ”¥ Auth state changed:', authResult.success);

            if (authResult.success && authResult.user) {
                // âœ… Utilisateur connectÃ©
                setUser(authResult.user);
                setIsSignedIn(true);

                // Sauvegarder localement
                AsyncStorage.setItem('user', JSON.stringify(authResult.user));
                AsyncStorage.setItem('userId', authResult.user.id);
            } else {
                // âŒ Pas d'utilisateur
                setUser(null);
                setIsSignedIn(false);

                // Nettoyer cache
                AsyncStorage.multiRemove(['user', 'userId']);
            }

            setIsLoading(false);
        });

        // ğŸ§¹ Nettoyer le listener
        return () => unsubscribe();
    }, []);

    // ğŸ” CONNEXION GOOGLE
    const signInWithGoogle = async () => {
        try {
            setIsLoading(true);
            setError(null);

            const result = await FirebaseGoogleAuth.signInWithGoogle();

            if (result.success) {
                // âœ… Le listener onAuthStateChanged va mettre Ã  jour l'Ã©tat
                console.log('âœ… Connexion Google rÃ©ussie');
                return result;
            } else {
                setError(result.error);
                return result;
            }

        } catch (error) {
            const errorMessage = error.message || 'Erreur de connexion';
            setError(errorMessage);
            return {
                success: false,
                error: errorMessage
            };
        } finally {
            setIsLoading(false);
        }
    };

    // ğŸšª DÃ‰CONNEXION
    const signOut = async () => {
        try {
            setIsLoading(true);

            const result = await FirebaseGoogleAuth.signOut();

            if (result.success) {
                // âœ… Le listener va nettoyer l'Ã©tat automatiquement
                console.log('âœ… DÃ©connexion rÃ©ussie');
            }

            return result;

        } catch (error) {
            setError(error.message);
            return {
                success: false,
                error: error.message
            };
        } finally {
            setIsLoading(false);
        }
    };

    // ğŸ‘¤ RÃ‰CUPÃ‰RER UTILISATEUR ACTUEL (sans listener)
    const getCurrentUser = () => {
        return FirebaseGoogleAuth.getCurrentUser();
    };

    // ğŸ§¹ NETTOYER ERREUR
    const clearError = () => {
        setError(null);
    };

    return {
        // ğŸ“Š Ã‰tat
        user,
        isSignedIn,
        isLoading,
        error,

        // ğŸ”§ Actions
        signInWithGoogle,
        signOut,
        getCurrentUser,
        clearError,

        // ğŸ” Utilitaires
        isAuthenticated: isSignedIn && user !== null,
    };
};